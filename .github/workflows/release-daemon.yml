# Build lockwaved daemon, generate checksums, create GitHub Release.
# Trigger: push tag v* (e.g. v1.2.3).
# Prunes GitHub releases to the latest 3 (see prune job env RELEASES_TO_KEEP).

name: Release Daemon

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history for changelog

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Create artifacts dir
        run: mkdir -p artifacts

      - name: Build binaries
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          LDFLAGS="-s -w -X main.version=${VERSION}"
          CGO_ENABLED=0 go build -ldflags "$LDFLAGS" -o artifacts/lockwaved-linux-amd64 ./cmd/lockwaved
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "$LDFLAGS" -o artifacts/lockwaved-linux-arm64 ./cmd/lockwaved
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags "$LDFLAGS" -o artifacts/lockwaved-darwin-amd64 ./cmd/lockwaved
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags "$LDFLAGS" -o artifacts/lockwaved-darwin-arm64 ./cmd/lockwaved
          CGO_ENABLED=0 GOOS=freebsd GOARCH=amd64 go build -ldflags "$LDFLAGS" -o artifacts/lockwaved-freebsd-amd64 ./cmd/lockwaved

      - name: Verify binary version
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          ACTUAL=$(./artifacts/lockwaved-linux-amd64 version 2>&1 | head -1)
          EXPECTED="lockwaved ${VERSION} (linux/amd64)"
          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Version mismatch: expected '${EXPECTED}', got '${ACTUAL}'"
            exit 1
          fi
          echo "Binary version verified: ${ACTUAL}"

      - name: Generate SHA-256 checksums
        working-directory: artifacts
        run: |
          sha256sum lockwaved-* > checksums.txt
          cat checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v7
        with:
          name: lockwaved-binaries
          path: artifacts/

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          sparse-checkout: packaging

      - name: Download artifacts
        uses: actions/download-artifact@v8
        with:
          name: lockwaved-binaries

      - name: Delete existing release (if any)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release delete "${{ github.ref_name }}" --repo "${{ github.repository }}" --yes --cleanup-tag=false 2>/dev/null || true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.build.outputs.version }}
        run: |
          gh release create "${{ github.ref_name }}" \
            lockwaved-* \
            checksums.txt \
            packaging/install.sh \
            --repo "${{ github.repository }}" \
            --title "lockwaved v${VERSION}" \
            --generate-notes \
            --latest

  prune:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      RELEASES_TO_KEEP: 3
    steps:
      - name: Prune old GitHub releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # List release tags (semver only), sort ascending (oldest first)
          tags=$(gh release list --repo "${{ github.repository }}" --limit 100 --json tagName -q '.[].tagName' \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' || true)
          if [ -z "$tags" ]; then
            echo "No semver release tags found."
            exit 0
          fi
          count=$(echo "$tags" | wc -l)
          if [ "$count" -le "$RELEASES_TO_KEEP" ]; then
            echo "Only $count release(s); keeping all."
            exit 0
          fi
          # Keep the newest RELEASES_TO_KEEP; delete the rest (oldest first)
          to_delete=$((count - RELEASES_TO_KEEP))
          echo "$tags" | sort -V | head -n "$to_delete" | while read -r tag; do
            echo "Deleting GitHub release: $tag"
            gh release delete "$tag" --repo "${{ github.repository }}" --yes
          done
